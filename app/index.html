<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>ExampleIG — 病歷摘要（o_index 風格｜GitHub 版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
  <style>
    :root{ --bg:#0b1220;--panel:#0f172a;--line:#1f2a44;--muted:#94a3b8;--text:#e2e8f0;--accent:#60a5fa }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui}

    /* 工具列（換成雙 icon） */
    .toolbar{
      display:flex;align-items:center;gap:12px;padding:12px 16px;
      border-bottom:1px solid var(--line);background:rgba(15,23,42,.7);
      position:sticky;top:0;backdrop-filter:blur(6px);z-index:10
    }
    .brand-logos{display:flex;align-items:center;gap:10px}
    .brand-logos img{height:28px;object-fit:contain;display:block;filter:drop-shadow(0 0 0 rgba(0,0,0,0))}
    .sep{width:1px;height:20px;background:var(--line);margin:0 6px}
    .status{font-size:13px;color:var(--muted)}
    .btn{background:#1f2937;border:1px solid #334155;color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .spacer{flex:1}
    .link{color:var(--accent);text-decoration:none}

    /* 兩欄佈局 */
    .wrap{display:grid;grid-template-columns:360px 1fr;gap:14px;max-width:1280px;margin:16px auto;padding:0 16px}
    @media (max-width:960px){.wrap{grid-template-columns:1fr}}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px}
    .searchRow{display:flex;gap:8px}
    input[type="text"]{flex:1;background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:10px 12px;color:var(--text)}

    /* 左側清單：調高上限高度，滑輪挑選 */
    .list{display:flex;flex-direction:column;gap:8px;max-height:72vh;overflow:auto;margin-top:10px}
    .item{border:1px solid var(--line);border-radius:12px;padding:10px;cursor:pointer}
    .item:hover{border-color:#334155;background:#0b1220}
    .muted{color:var(--muted);font-size:13px}
    .warn{display:none;margin-top:10px;background:#fff3cd;color:#664d03;border:1px solid #eab308;padding:10px;border-radius:10px}

    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .kv{border:1px dashed var(--line);border-radius:12px;padding:8px;font-size:14px}
    .subttl{margin:14px 0 8px}
    .tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px}
    .code{font-family:ui-monospace,SFMono-Regular,Consolas,monospace;font-size:12px;color:#cbd5e1}
  </style>
</head>
<body>
  <!-- 工具列：文字品牌 → 兩個 icon -->
  <div class="toolbar">
    <div class="brand-logos">
      <img src="logo_fubon.png" alt="Fubon Biomed" />
      <img src="logo_rehabotics.png" alt="Rehabotics" />
    </div>
    <div class="sep"></div>
    <button id="btnToLaunch" class="btn" title="回授權入口">回到 Launch</button>
    <button id="btnReload" class="btn" title="重新整理頁面">重新整理</button>
    <div class="spacer"></div>
    <div class="status" id="authState">授權檢查中…</div>
  </div>

  <div class="wrap">
    <!-- 左側：搜尋 + 病人列表 -->
    <div class="panel">
      <div class="searchRow">
        <input id="q" type="text" placeholder="搜尋病人姓名（例：smith）" />
        <button id="btnSearch" class="btn">搜尋</button>
      </div>
      <div id="authWarn" class="warn">尚未完成授權。請先從 <a class="link" href="launch.html">launch.html</a> 啟動 SMART。</div>
      <div class="list" id="patientList"></div>
    </div>

    <!-- 右側：詳情（病人基本 + 量表摘要） -->
    <div class="panel">
      <div id="emptyHint" class="muted">請在左側搜尋並選擇一位病人。</div>

      <div id="detail" style="display:none">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px">
          <h2 id="ptTitle" style="margin:0;font-size:18px">—</h2>
          <span id="ptMeta" class="tag">—</span>
          <div class="spacer"></div>
          <button id="btnShowPatientJson" class="btn">病人原始資料</button>
          <button id="btnShowAllQRJson" class="btn">量表原始資料</button>
        </div>

        <div class="grid2" style="margin-top:8px">
          <div class="kv"><div class="muted">性別</div><div id="ptGender">—</div></div>
          <div class="kv"><div class="muted">生日</div><div id="ptBirth">—</div></div>
        </div>

        <h3 id="qrTitle" class="subttl">量表摘要（QuestionnaireResponse）</h3>
        <div id="qrList" class="list" style="max-height:40vh"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== DOM refs =====
    const $ = s => document.querySelector(s);
    const patientListEl = $("#patientList");
    const qrListEl = $("#qrList");
    const authWarn = $("#authWarn");
    const authState = $("#authState");
    const emptyHint = $("#emptyHint");
    const detailWrap = $("#detail");
    const btnSearch = $("#btnSearch");
    const qEl = $("#q");
    const qrTitle = $("#qrTitle");

    // ===== 全域狀態 =====
    let client = null;
    let currentPatient = null;
    let currentQRs = [];

    // ===== Toolbar actions =====
    $("#btnToLaunch").onclick = () => location.href = "launch.html";
    $("#btnReload").onclick   = () => location.reload();

    // 啟動：嘗試取得 OAuth client；失敗就提示回 launch
    (async () => {
      try {
        client = await FHIR.oauth2.ready();
        authState.textContent = "授權完成 ✅";
      } catch (e) {
        console.warn("尚未授權", e);
        authState.textContent = "未授權";
        authWarn.style.display = "block";
      }
    })();

    // ===== 搜尋病人 =====
    btnSearch.onclick = doSearch;
    qEl.addEventListener("keydown", e => { if(e.key==="Enter") doSearch(); });

    // ② 把病人「全部列出來」：遞迴追 next 直到抓完
    async function fetchAllPatientsByName(name){
      let url = `Patient?name=${encodeURIComponent(name)}&_count=100`;
      const results = [];
      while (url){
        const bundle = await client.request(url, {flat:false});
        const items = (bundle.entry||[]).map(e=>e.resource).filter(r=>r.resourceType==="Patient");
        results.push(...items);
        const next = (bundle.link||[]).find(l=>l.relation==="next")?.url;
        url = next || null;
      }
      return results;
    }

    async function doSearch(){
      if(!client){
        authWarn.style.display = "block";
        return;
      }
      const key = qEl.value.trim();
      if(!key){ qEl.focus(); return; }

      btnSearch.disabled = true;
      patientListEl.innerHTML = `<div class="muted">搜尋中…</div>`;
      try{
        const pats = await fetchAllPatientsByName(key);
        renderPatientList(pats);
      }catch(err){
        console.error(err);
        patientListEl.innerHTML = `<div class="muted">搜尋失敗：${escapeHtml(String(err))}</div>`;
      }finally{
        btnSearch.disabled = false;
      }
    }

    function renderPatientList(pats){
      if(!pats.length){
        patientListEl.innerHTML = `<div class="muted">沒有找到病人</div>`;
        return;
      }
      patientListEl.innerHTML = "";
      for(const p of pats){
        const name = formatName(p.name?.[0]) || "(未命名)";
        const gender = p.gender || "—";
        const birth  = p.birthDate || "—";
        const dom = document.createElement("div");
        dom.className = "item";
        dom.innerHTML = `
          <div><strong>${escapeHtml(name)}</strong></div>
          <div class="muted">性別：${escapeHtml(gender)}　生日：${escapeHtml(birth)}</div>
        `;
        dom.onclick = ()=>selectPatient(p);
        patientListEl.appendChild(dom);
      }
    }

    // ===== 右側詳情：病人基本 + 量表摘要 =====
    async function selectPatient(p){
      currentPatient = p;
      emptyHint.style.display = "none";
      detailWrap.style.display = "block";

      // ① 點病人 → 搜尋框自動填姓氏（family），並優先顯示量表
      const family = (p.name?.[0]?.family || "").trim();
      if (family) qEl.value = family;

      $("#ptTitle").textContent = formatName(p.name?.[0]) || "(未命名)";
      $("#ptGender").textContent = p.gender || "—";
      $("#ptBirth").textContent  = p.birthDate || "—";
      $("#ptMeta").textContent   = p.id ? `ID: ${p.id}` : "—";
      $("#btnShowPatientJson").onclick = ()=> showJson(p);

      // 先把量表區塊捲到視野，營造「先顯示量表」的體驗
      setTimeout(()=> qrTitle.scrollIntoView({behavior:"smooth", block:"start"}), 50);

      // 載入量表
      qrListEl.innerHTML = `<div class="muted">載入量表中…</div>`;
      try{
        const bundle = await client.request(
          `QuestionnaireResponse?patient=${encodeURIComponent(p.id)}&_count=100&_sort=-_lastUpdated`,
          {flat:false}
        );
        currentQRs = (bundle.entry||[]).map(e=>e.resource).filter(r=>r.resourceType==="QuestionnaireResponse");

        // 若伺服器還有下一頁，也把它們抓進來
        let nextUrl = (bundle.link||[]).find(l=>l.relation==="next")?.url;
        while (nextUrl){
          const b2 = await client.request(nextUrl, {flat:false});
          currentQRs.push(...(b2.entry||[]).map(e=>e.resource).filter(r=>r.resourceType==="QuestionnaireResponse"));
          nextUrl = (b2.link||[]).find(l=>l.relation==="next")?.url || null;
        }

        $("#btnShowAllQRJson").onclick = ()=> showJson(currentQRs);
        renderQRList(currentQRs);
      }catch(err){
        console.error(err);
        qrListEl.innerHTML = `<div class="muted">量表載入失敗：${escapeHtml(String(err))}</div>`;
      }
    }

    function renderQRList(qrs){
      if(!qrs.length){
        qrListEl.innerHTML = `<div class="muted">找不到量表回答</div>`;
        return;
      }
      qrListEl.innerHTML = "";
      for(const qr of qrs){
        const authored = qr.authored || "—";
        const qRef = qr.questionnaire || "—";
        const brief = extractScore(qr) ?? "—";
        const dom = document.createElement("div");
        dom.className = "item";
        dom.innerHTML = `
          <div><strong>${escapeHtml(shortRef(qRef))}</strong></div>
          <div class="muted">時間：${escapeHtml(authored)}</div>
          <div class="muted">摘要：${escapeHtml(String(brief))}</div>
        `;
        dom.onclick = ()=> showJson(qr);
        qrListEl.appendChild(dom);
      }
    }

    // ===== 小工具 =====
    function showJson(obj){
      const w = window.open("","_blank");
      w.document.write(`<pre class="code" style="white-space:pre-wrap;word-break:break-word;padding:16px;background:#0b1220;color:#cbd5e1;margin:0">${escapeHtml(JSON.stringify(obj,null,2))}</pre>`);
    }
    function formatName(n){
      if(!n) return "";
      const given = Array.isArray(n.given) ? n.given.join(" ") : (n.given || "");
      const family = n.family || "";
      return `${family} ${given}`.trim() || n.text || "(未命名)";
    }
    function shortRef(ref){
      if(!ref) return "Questionnaire —";
      const s = String(ref);
      try{ if(/^http/i.test(s)) return new URL(s).pathname.split("/").pop() || s; }catch{}
      return s.split("/").pop() || s;
    }
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[s]));
    }
    // 嘗試從 linkId 名稱包含 total/score/sum 的 item 取值（若你有固定 linkId 可改成精準比對）
    function extractScore(qr){
      const walk = items => {
        if(!items) return null;
        for(const it of items){
          if (/(total|score|sum)/i.test(it.linkId||"")) {
            const ans = it.answer?.[0];
            if(ans){
              const v = ans.valueInteger ?? ans.valueDecimal ?? ans.valueQuantity?.value ?? ans.valueString;
              if(v!=null) return v;
            }
          }
          const sub = walk(it.item);
          if(sub!=null) return sub;
        }
        return null;
      };
      return walk(qr.item);
    }
  </script>
</body>
</html>
