<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ExampleIG â€” ç—…æ‚£è³‡æ–™å„€è¡¨æ¿</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; background: #f8fafc; color: #222; }
    h1 { text-align: center; }
    .search-box { display:flex; gap:8px; margin:20px auto; justify-content:center; }
    input { padding:8px; border-radius:6px; border:1px solid #ccc; min-width:200px; }
    button { padding:8px 16px; border:none; background:#2563eb; color:white; border-radius:6px; cursor:pointer; }
    button:hover { background:#1e40af; }
    .row { background:white; margin:10px auto; max-width:600px; border-radius:10px; box-shadow:0 1px 4px rgba(0,0,0,0.1); padding:10px 15px; display:flex; justify-content:space-between; align-items:center; }
    pre { background:#f1f5f9; padding:10px; border-radius:8px; overflow:auto; }
  </style>
</head>
<body>
  <h1>ğŸ¥ ExampleIG ç—…æ‚£è³‡æ–™å„€è¡¨æ¿</h1>

  <div class="search-box">
    <input id="kw" type="text" placeholder="è¼¸å…¥ç—…äººå§“å..." />
    <button id="btnSearch">æœå°‹</button>
  </div>

  <div id="results"></div>

  <h2>ğŸ§ ç—…äººè³‡æ–™</h2>
  <pre id="summary">{ å°šæœªè¼‰å…¥ }</pre>

  <h2>ğŸ–ï¸ ARAT çµæœ</h2>
  <pre id="arat">{ å°šæœªè¼‰å…¥ }</pre>

  <script>
    const $ = (q) => document.querySelector(q);
    const fmt = (o) => JSON.stringify(o, null, 2);
    let client;

    // æ‹¿åˆ°æˆæ¬Šå¾Œçš„ FHIR client
    FHIR.oauth2.ready().then(c => { client = c; });

    $("#btnSearch").onclick = async () => {
      const kw = $("#kw").value.trim();
      $("#results").innerHTML = "<p style='text-align:center;color:#777'>æœå°‹ä¸­...</p>";
      try {
        const bundle = await client.request(`Patient?name=${encodeURIComponent(kw)}&_count=5`, { flat: true });
        const patients = (bundle.entry || []).map(e => e.resource);
        if (!patients.length) {
          $("#results").innerHTML = "<p style='text-align:center;color:#777'>æŸ¥ç„¡è³‡æ–™</p>";
          return;
        }
        $("#results").innerHTML = patients.map(p => `
          <div class="row">
            <div>
              <strong>${(p.name?.[0]?.text) || "(ç„¡å)"}</strong><br>
              æ€§åˆ¥ï¼š${p.gender || "â€”"}ã€€å‡ºç”Ÿæ—¥æœŸï¼š${p.birthDate || "â€”"}
            </div>
            <button onclick="loadPatient('${p.id}')">æŸ¥çœ‹</button>
          </div>
        `).join('');
      } catch (e) {
        console.error(e);
        $("#results").innerHTML = "<p style='color:#c00'>æœå°‹å¤±æ•—</p>";
      }
    };

    async function loadPatient(id) {
      $("#summary").textContent = "è¼‰å…¥ä¸­...";
      $("#arat").textContent = "è¼‰å…¥ä¸­...";
      try {
        const patient = await client.request(`Patient/${id}`);
        $("#summary").textContent = fmt(patient);

        // å˜—è©¦è®€å–è©²ç—…äººæœ€è¿‘çš„ QuestionnaireResponseï¼ˆæ¨¡æ“¬ ARATï¼‰
        const qr = await client.request(`QuestionnaireResponse?subject=Patient/${id}&_sort=-_lastUpdated&_count=1`, { flat: true });
        const latest = (qr.entry?.[0]?.resource) || { note: "æœªæ‰¾åˆ°é‡è¡¨çµæœ" };
        $("#arat").textContent = fmt(latest);
      } catch (e) {
        $("#summary").textContent = "{ è®€å–å¤±æ•— }";
        $("#arat").textContent = "{ è®€å–å¤±æ•— }";
        console.error(e);
      }
    }
  </script>
</body>
</html>
