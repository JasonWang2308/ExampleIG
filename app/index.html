<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ExampleIG — 病患資料儀表板</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; background: #f8fafc; color: #222; }
    h1 { text-align: center; }
    .search-box { display:flex; gap:8px; margin:20px auto; justify-content:center; }
    input { padding:8px; border-radius:6px; border:1px solid #ccc; min-width:200px; }
    button { padding:8px 16px; border:none; background:#2563eb; color:white; border-radius:6px; cursor:pointer; }
    button:hover { background:#1e40af; }
    .row { background:white; margin:10px auto; max-width:600px; border-radius:10px; box-shadow:0 1px 4px rgba(0,0,0,0.1); padding:10px 15px; display:flex; justify-content:space-between; align-items:center; }
    pre { background:#f1f5f9; padding:10px; border-radius:8px; overflow:auto; }
  </style>
</head>
<body>
  <h1>🏥 ExampleIG 病患資料儀表板</h1>

  <div class="search-box">
    <input id="kw" type="text" placeholder="輸入病人姓名..." />
    <button id="btnSearch">搜尋</button>
  </div>

  <div id="results"></div>

  <h2>🧍 病人資料</h2>
  <pre id="summary">{ 尚未載入 }</pre>

  <h2>🖐️ ARAT 結果</h2>
  <pre id="arat">{ 尚未載入 }</pre>

  <script>
    const $ = (q) => document.querySelector(q);
    const fmt = (o) => JSON.stringify(o, null, 2);
    let client;

    // 拿到授權後的 FHIR client
    FHIR.oauth2.ready().then(c => { client = c; });

    $("#btnSearch").onclick = async () => {
      const kw = $("#kw").value.trim();
      $("#results").innerHTML = "<p style='text-align:center;color:#777'>搜尋中...</p>";
      try {
        const bundle = await client.request(`Patient?name=${encodeURIComponent(kw)}&_count=5`, { flat: true });
        const patients = (bundle.entry || []).map(e => e.resource);
        if (!patients.length) {
          $("#results").innerHTML = "<p style='text-align:center;color:#777'>查無資料</p>";
          return;
        }
        $("#results").innerHTML = patients.map(p => `
          <div class="row">
            <div>
              <strong>${(p.name?.[0]?.text) || "(無名)"}</strong><br>
              性別：${p.gender || "—"}　出生日期：${p.birthDate || "—"}
            </div>
            <button onclick="loadPatient('${p.id}')">查看</button>
          </div>
        `).join('');
      } catch (e) {
        console.error(e);
        $("#results").innerHTML = "<p style='color:#c00'>搜尋失敗</p>";
      }
    };

    async function loadPatient(id) {
      $("#summary").textContent = "載入中...";
      $("#arat").textContent = "載入中...";
      try {
        const patient = await client.request(`Patient/${id}`);
        $("#summary").textContent = fmt(patient);

        // 嘗試讀取該病人最近的 QuestionnaireResponse（模擬 ARAT）
        const qr = await client.request(`QuestionnaireResponse?subject=Patient/${id}&_sort=-_lastUpdated&_count=1`, { flat: true });
        const latest = (qr.entry?.[0]?.resource) || { note: "未找到量表結果" };
        $("#arat").textContent = fmt(latest);
      } catch (e) {
        $("#summary").textContent = "{ 讀取失敗 }";
        $("#arat").textContent = "{ 讀取失敗 }";
        console.error(e);
      }
    }
  </script>
</body>
</html>
